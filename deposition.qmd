---
title: "Untitled"
format: html
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r}
1 + 1
```

You can add options to executable code like this

```{r}
#| echo: false
library(stars)

process_raster_1 <- function(raster){
  read_ncdf(raster, eps = 0.001) |>
  transmute(dust_wet = DUWT001 + DUWT002 + DUWT003 + DUWT004 + DUWT005,
            dust_dry = DUDP001 + DUDP002 + DUDP003 + DUDP004 + DUDP005,
            seasalt_wet = SSWT001 + SSWT002 + SSWT003 + SSWT004 + SSWT005,
            seasalt_dry = SSDP001 + SSDP002 + SSDP003 + SSDP004 + SSDP005)
}


process_raster_2 <- function(raster){
  read_ncdf(raster, eps = 0.001) |>
  transmute(black_carbon_wet = BCWT001 + BCWT002,
            black_carbon_dry = BCDP001 + BCDP002 ,
            sulfate_dry = SUDP001 + SUDP002 + SUDP003 + SUDP004,
            sulfate_wet = SUWT001 + SUWT002 + SUWT003 + SUWT004,
            organic_carbon_dry = OCDP001 + OCDP002,
            organic_carbon_wet = OCWT001 + OCWT002)
}


files1 <- list.files(here('data/raw/MERRA2'), pattern = '.nc4', full.names = TRUE) |>
  str_subset('DUD') |> 
  map(process_raster_1)
  
combined_stars1 <- do.call(c, c(files1, list(along = "time"))) |>
  st_apply(1:2, mean, na.rm = TRUE)

saveRDS(combined_stars, here('data/derived/deposition.rds'))

files2 <- list.files(here('data/raw/MERRA2'), pattern = '.nc4', full.names = TRUE) |>
  str_subset('BCD') %>%
  map(process_raster_2)
  
combined_stars2 <- do.call(c, c(files2, list(along = "time"))) |>
  st_apply(1:2, mean, na.rm = TRUE)

combined_stars <- c(combined_stars1, combined_stars2)


saveRDS(combined_stars, here('data/derived/aerosols.rds'))

```


```{r}
plot(merge(combined_stars))
sf_use_s2(FALSE)
mexico_bbox <- st_bbox(c(xmin = -106, xmax = -87, ymin = 15, ymax = 23), crs = 4326)

ggplot() +
  geom_stars(data = merge(combined_stars)) +
  scale_fill_viridis_c() +
  facet_wrap(~attributes) +
  coord_quickmap()

library(terra)
names(mexico_predictors)
mexico_predictors[['seasalt_dep']] |> plot()
test2 <- combined_stars |> st_crop(mexico_bbox) |> rast()
test3 <- project(test2[[3]] + test2[[4]], mexico_predictors[['seasalt_dep']], method = 'cubicspline')
test4 <- project(test2[[3]] + test2[[4]], mexico_predictors[['seasalt_dep']])

mexico_predictors[['seasalt_dep']] |> plot()
plot(test3 |> mask(mexico_predictors[['seasalt_dep']]))
plot(test4 |> mask(mexico_predictors[['seasalt_dep']]))

names(mexico_predictors)
test5 <- project(test2[[1]] + test2[[2]], mexico_predictors[['seasalt_dep']], method = 'cubicspline')

plot(mexico_predictors[[c(65:73, 79:80)]])

plot(mexico_predictors[[71]])
plot(test5|> mask(mexico_predictors[['seasalt_dep']]))
```

The `echo: false` option disables the printing of code (only output is displayed).
