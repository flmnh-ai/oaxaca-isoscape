---
title: "Oaxaca Isoscape"
format: html
editor: visual
---

## Setup

Load required packages.

```{r}
library(stars)
library(sf)
library(tidyverse)
library(readxl)
library(rnaturalearth)

library(tidymodels)
library(spatialsample)
library(future)
library(bonsai)
library(vip)

plan(multisession) # use all available cores for parallel processing
```

### Preprocess Global Raster Predictors

extents are the same, but its the resolution that doesn't match

vars 2 and 3 are multi resolution? its from lc and age_min. or all the age_min/max srsq layers in vars3? but they all read as having the same resolution when checking dimensions

looks like everything but vars3 is the same projection, just not necessarily named that? and why does vars3 then need to be reprojected? ah its listed as world eckertIV rather than just eckert IV

```{r}
vars1 <- list.files('data/data-raw/isotope_predictors', pattern = 'reproj', full.names = TRUE)[c(3:4, 6:9, 11:12, 21:22)] |>
  read_stars() %>%
    setNames(., str_remove(names(.), '_reproj.tif'))

eck4 <- st_crs(vars1)

vars2 <- list.files('data/data-raw/isotope_predictors', pattern = 'reproj', full.names = TRUE)[-c(3:4, 6:9, 11:12, 21:22)] %>%
  .[-5] |> # remove lc for now to test resolution issue
  read_stars()  %>%
  setNames(., str_remove(names(.), '_reproj.tif')) |>
  select(-lc) |>
  st_set_crs(eck4)

vars3 <- list.files('data/data-raw/isotope_predictors', pattern = '\\.tif$', full.names = TRUE) %>%
  str_subset('reproj', negate = TRUE) %>%
  .[c(1:2, 32:34, 39)] %>%
    .[c(1:2, 4:5)] |>
  read_stars() %>%
  setNames(., str_remove(names(.), '.tif')) |>
  st_set_crs(eck4)

vars4 <- list.files('data/data-raw/isotope_predictors', pattern = '^r.', full.names = TRUE) %>%
  .[-c(26, 28:32)] |>
  read_stars() %>%
  setNames(., str_remove(names(.), '.tif')) |>
  st_set_crs(eck4)

predictors <- c(vars1, vars2, vars3, vars4) |>
  select(-magt, -perma) # incomplete variables? # also, this doesn't seem to remove them?
```


```{r}
oaxaca_bbox <- st_bbox(c(xmin = -106, xmax = -92, ymin = 12, ymax = 24), crs = 4326) |>
  st_transform(eck4) 

world <- ne_countries() |>
  st_transform(eck4)

oaxaca_preds <- st_crop(c(vars1, vars2, vars4), oaxaca_bbox) |>
  st_as_stars() |>
  c(st_as_stars(st_crop(vars3, oaxaca_bbox))) |>
  select(-magt, -perma) # incomplete variables?
```

```{r}
plot(merge(oaxaca_preds), join_zlim = TRUE)
```

### Preprocess Global Isotope Observations

```{r}
pts <- read_excel('data/data-raw/1-s2.0-S0031018220302947-mmc1.xlsx', sheet = 2, guess_max = 100000) |>
  mutate(sr = str_replace(`87Sr/86Sr`, ',', '.'),
         sr = parse_number(sr)) |>
  filter(sr <= 0.75) |> # confirm with sofia or look at types more critically
  select(sr, Longitude, Latitude, type = `Type 1`) |> # keep Type 1 and 2 and Material?
  mutate(type = if_else(type == 'water', 'Water', type),
         type = if_else(type == 'mammal', 'Mammal', type)) |>
  filter(type %in% c('Plant', 'Mammal', 'Water', 'Invertebrates', 'Minerals', 'Rock')) |>
  remove_missing() |> # some rows don't have Sr measurements
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = 4326) |>
  st_transform(eck4)
```

```{r}
ggplot(pts) +
  geom_sf(data = st_as_sfc(world), color = 'lightgrey') + # so type doesn't get invovled
  geom_sf(aes(color = type), alpha = 0.5, size = .1) +
  theme_bw() +
  facet_wrap(~type)
```
```{r}
ggplot(pts) +
  geom_bar(aes(type)) +
  theme_bw() +
  coord_flip()
```

```{r}
ggplot(pts) +
  geom_histogram(aes(sr)) +
  theme_bw()

pts |>
  arrange(sr) |>
ggplot() +
  geom_sf(data = world, color = 'lightgrey') +
  geom_sf(aes(color = sr), size = 0.1) +
  scale_color_viridis_c() +
  theme_bw()
```

### Final Data for Modeling

```{r}
dat <- predictors |>
  st_extract(pts) |>
  mutate(sr = pts$sr,
         type = factor(pts$type)) |>
  select(-magt, -perma) |> # because not removed from rasters
  remove_missing() # only necessary for rf
```


## Modeling

```{r}
set.seed(1111)
#folds <- spatial_clustering_cv(dat, v = 8)
#folds <- spatial_block_cv(dat)
folds <- vfold_cv(dat, v = 5)
#autoplot(folds)
```

```{r}
rf_mod <- rand_forest(mode = 'regression',
                      mtry = tune(),
                      min_n = tune()) |>
  set_engine('ranger', importance = 'permutation')

rec <- recipe(sr ~ ., dat) |>
  update_role(c(type, geometry), new_role = 'other') |>
  update_role_requirements('other', bake = FALSE)

boost_mod <- boost_tree(mode = 'regression', 
                        mtry = tune(), 
                        trees = tune(), 
                        tree_depth = tune(), 
                        learn_rate = tune(), 
                        loss_reduction = tune(), 
                        min_n = tune()) |>
  set_engine('lightgbm', 
             importance = 'permutation', 
             num_leaves = tune())

#bart_mod <- bart(mode = 'regression', 
#             trees = tune(),
#             prior_terminal_node_coef = tune(),
#             prior_terminal_node_expo = tune(),
#             prior_outcome_range = tune())
  
rf_wflw <- workflow(rec, spec = rf_mod)
boost_wflw <- workflow(rec, spec = boost_mod) 

#bart_wflw <- workflow(sr ~ ., spec = bart_mod)

rf_params <- extract_parameter_set_dials(rf_wflw) |>
  update(mtry = mtry(range = c(1, 20)))

boost_params <- extract_parameter_set_dials(boost_wflw) |>
  update(loss_reduction = loss_reduction(range = c(-10, -4)),
         learn_rate = learn_rate(range = c(-4, -1)))

control <- control_grid(save_pred = TRUE, pkgs = 'sf') # needed for parallel processing when geometry columns present

resamp_rf <- tune_grid(rf_wflw, folds, 
                       grid = 40, 
                       param_info = rf_params,
                       control = control)

resamp_boost <- tune_grid(boost_wflw, folds, 
                          grid = 80, 
                          param_info = boost_params, 
                          control = control)
#resamp_bart <- tune_grid(bart_wflw, folds, grid = 30, control = control)
```

```{r}
autoplot(resamp_rf)
```

```{r}
autoplot(resamp_boost)
```

```{r}
autoplot(resamp_bart)
```

```{r}
show_best(resamp)
show_best(resamp_boost)
#show_best(resamp_bart)

select_best(resamp)
select_best(resamp_boost)
#select_best(resamp_bart)
```

```{r}
final_fit <- resamp_boost %>%
  select_best(metric = 'rmse') %>%
  finalize_workflow(boost_wflw, .) %>%
  fit(dat) 

base_fit <- resamp_rf %>%
  select_best(metric = 'rmse') %>%
  finalize_workflow(rf_wflw, .) %>%
  fit(dat) 
```

```{r}
vip(extract_fit_engine(final_fit), num_features = 60)
vip(extract_fit_engine(base_fit), num_features = 60)
```
```{r}
augment(final_fit, dat) %>%
  ggplot(aes(sr, .pred)) +
  geom_point(aes(color = type), size = 0.2, alpha = 0.5) +
  geom_abline() +
  coord_equal() +
  theme_bw()

augment(base_fit, dat) %>%
  ggplot(aes(sr, .pred)) +
  geom_point(aes(color = type), size = 0.2, alpha = 0.5) +
  geom_abline() +
  coord_equal() +
  theme_bw()
```
# Oaxa predictions

```{r}
mex_preds <- predict(oaxaca_preds, 
                     extract_fit_parsnip(final_fit), 
                     na.rm = TRUE)
```

```{r}
#library(terra)
mex_preds <- oaxaca_preds |>
  terra::rast() |>
  setNames(names(oaxaca_preds)) |>
  terra::predict(extract_fit_parsnip(base_fit), na.rm = TRUE)
  #terra::predict(extract_fit_parsnip(final_fit), na.rm = TRUE)

terra::plot(mex_preds)
#oaxaca_predictions <- predict(oaxaca_preds, extract_fit_parsnip(final_fit), na.rm = TRUE)
```

```{r}
iso <- read_excel('data/data-raw/OAX Sr Result Table.xlsx') %>%
  st_as_sf(coords = c('UTM-E', 'UTM-N'), crs = 32614) |>
  st_transform(st_crs(mex_preds))
```

```{r}
plot(iso)
```

```{r}
terra::extract(mex_preds, iso, bind = TRUE) |>
  as.data.frame() |>
  ggplot(aes(Sr, .pred)) +
  geom_point() +
  geom_abline()
```

```{r}
terra::extract(mex_preds, iso, bind=T) |>
  as.data.frame() |>
  ggplot(aes(Sr, .pred)) +
  geom_point(aes(color = Branch)) +
  geom_abline()
```

```{r}
terra::extract(mex_preds, iso, bind=T) |>
  as.data.frame() |>
  ggplot(aes(Sr, .pred)) +
  geom_point(aes(color = Locality)) +
  geom_abline()
```

```{r}
terra::extract(mex_preds, iso, bind=T) |>
  as.data.frame() |>
  ggplot(aes(Sr, .pred)) +
  geom_point(aes(color = `Plant Rooting Depth`)) +
  geom_abline()
```

```{r}
terra::extract(mex_preds, iso, bind=T) |>
  as.data.frame() |>
  ggplot(aes(Sr, .pred)) +
  geom_point(aes(color = Species)) +
  geom_abline()
```
